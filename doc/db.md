## 初始化数据库

supabase sql editor 中创建表结构

```

-- 1. Create profiles table
drop table if exists public.profiles cascade;

create table public.profiles (
  id uuid primary key references auth.users(id) on delete cascade,
  role text check (role in ('admin', 'membership', 'visitor')) not null,
  email text unique not null,
  points integer default 0,             
  full_name text,                       
  birthday date                         
);

-- Enable RLS
alter table public.profiles enable row level security;

-- Policy for INSERT
create policy "Users can insert own profile"
on public.profiles for insert
with check (auth.uid() = id);

-- Policy for UPDATE
create policy "Users can update own profile"
on public.profiles for update
using (auth.uid() = id);

-- Policy for SELECT
create policy "Users can view own profile"
on public.profiles for select
using (auth.uid() = id);

-- 2. Function to auto create profile after new user is created
create or replace function public.handle_new_user()
returns trigger
language plpgsql security definer set search_path = public
as $$
begin
  insert into public.profiles (id, email, role, points) 
  values (NEW.id, NEW.email, 'visitor', 0); -- 默认积分 0，角色 visitor
  return NEW;
end;
$$;

-- 3. Trigger for new user creation
drop trigger if exists on_auth_user_created on auth.users;

create trigger on_auth_user_created
after insert on auth.users
for each row execute procedure public.handle_new_user();

-- 4. test case table

drop table if exists public.item cascade;

create table public.item (
  id bigint generated by default as identity primary key,
  inserted_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null,
  data jsonb,
  image text
);

insert into public.item (data, image) values
  ('{"name": "Alice", "age": 25, "role": "admin"}', 'https://iqcotzorsugbzmdnlsrc.supabase.co/storage/v1/object/public/bucket-ygf/tmp.png'),
  ('{"name": "Bob", "age": 30, "role": "member"}', 'https://iqcotzorsugbzmdnlsrc.supabase.co/storage/v1/object/public/bucket-ygf/tmp.png'),
  ('{"name": "Charlie", "age": 28, "role": "visitor"}', 'https://iqcotzorsugbzmdnlsrc.supabase.co/storage/v1/object/public/bucket-ygf/tmp.png');
  
```